#!/bin/sh -vx
#This script need to run on VPS host. 
#It is to renew the Let's Encrypt HTTPS(SSL) cert (pem file) using the Certbot tool.
#   ref: https://certbot.eff.org/#centos6-other
#
# Let's Encrypt's cert will expire every 3 month. Configure this script in a cron job for schedule running.
#   e.g. configure cron job with following config line using conrtab 'crontab -u root -e'
#            59 1 1 1,4,7,10 * /home/eastman/eastman_blog/renew_ssl_cert.sh
#        It runs on every 1st of Jan,Apr,Jul,Oct, 1:59 AM.


#renew the cert (use --dry-run to simulate the renewal without really writing to file)
#/usr/sbin/certbot-auto renew --dry-run
/usr/sbin/certbot-auto renew
+ /usr/sbin/certbot-auto renew
Upgrading certbot-auto 0.18.1 to 0.18.2...
Replacing certbot-auto...
Creating virtual environment...
Installing Python packages...
Had a problem while installing Python packages.

pip prints the following errors: 
=====================================================
DEPRECATION: Python 2.6 is no longer supported by the Python core team, please upgrade your Python. A future version of pip will drop support for Python 2.6
Requirement already satisfied: argparse==1.4.0 in /opt/eff.org/certbot/venv/lib/python2.6/site-packages (from -r /tmp/tmp.JYJ3zJiaoE/letsencrypt-auto-requirements.txt (line 11))
Collecting pycparser==2.14 (from -r /tmp/tmp.JYJ3zJiaoE/letsencrypt-auto-requirements.txt (line 17))
/opt/eff.org/certbot/venv/lib/python2.6/site-packages/pip/_vendor/requests/packages/urllib3/util/ssl_.py:318: SNIMissingWarning: An HTTPS request has been made, but the SNI (Subject Name Indication) extension to TLS is not available on this platform. This may cause the server to present an incorrect TLS certificate, which can cause validation failures. You can upgrade to a newer version of Python to solve this. For more information, see https://urllib3.readthedocs.io/en/latest/security.html#snimissingwarning.
  SNIMissingWarning
/opt/eff.org/certbot/venv/lib/python2.6/site-packages/pip/_vendor/requests/packages/urllib3/util/ssl_.py:122: InsecurePlatformWarning: A true SSLContext object is not available. This prevents urllib3 from configuring SSL appropriately and may cause certain SSL connections to fail. You can upgrade to a newer version of Python to solve this. For more information, see https://urllib3.readthedocs.io/en/latest/security.html#insecureplatformwarning.
  InsecurePlatformWarning
  Downloading pycparser-2.14.tar.gz (223kB)
Collecting asn1crypto==0.22.0 (from -r /tmp/tmp.JYJ3zJiaoE/letsencrypt-auto-requirements.txt (line 21))
  Downloading asn1crypto-0.22.0-py2.py3-none-any.whl (97kB)
Collecting cffi==1.10.0 (from -r /tmp/tmp.JYJ3zJiaoE/letsencrypt-auto-requirements.txt (line 24))
  Downloading cffi-1.10.0-cp26-cp26mu-manylinux1_x86_64.whl (392kB)
Collecting ConfigArgParse==0.12.0 (from -r /tmp/tmp.JYJ3zJiaoE/letsencrypt-auto-requirements.txt (line 61))
  Downloading ConfigArgParse-0.12.0.tar.gz (41kB)
Collecting configobj==5.0.6 (from -r /tmp/tmp.JYJ3zJiaoE/letsencrypt-auto-requirements.txt (line 63))
  Downloading configobj-5.0.6.tar.gz
Collecting cryptography==2.0.2 (from -r /tmp/tmp.JYJ3zJiaoE/letsencrypt-auto-requirements.txt (line 65))
  Downloading cryptography-2.0.2-cp26-cp26mu-manylinux1_x86_64.whl (2.2MB)
Collecting enum34==1.1.2 (from -r /tmp/tmp.JYJ3zJiaoE/letsencrypt-auto-requirements.txt (line 96))
  Downloading enum34-1.1.2.tar.gz (46kB)
Collecting funcsigs==1.0.2 (from -r /tmp/tmp.JYJ3zJiaoE/letsencrypt-auto-requirements.txt (line 99))
  Downloading funcsigs-1.0.2-py2.py3-none-any.whl
Collecting idna==2.5 (from -r /tmp/tmp.JYJ3zJiaoE/letsencrypt-auto-requirements.txt (line 102))
  Downloading idna-2.5-py2.py3-none-any.whl (55kB)
Collecting ipaddress==1.0.16 (from -r /tmp/tmp.JYJ3zJiaoE/letsencrypt-auto-requirements.txt (line 105))
  Downloading ipaddress-1.0.16.tar.gz
Collecting linecache2==1.0.0 (from -r /tmp/tmp.JYJ3zJiaoE/letsencrypt-auto-requirements.txt (line 108))
  Downloading linecache2-1.0.0-py2.py3-none-any.whl
Collecting ordereddict==1.1 (from -r /tmp/tmp.JYJ3zJiaoE/letsencrypt-auto-requirements.txt (line 111))
  Downloading ordereddict-1.1.tar.gz
Collecting packaging==16.8 (from -r /tmp/tmp.JYJ3zJiaoE/letsencrypt-auto-requirements.txt (line 113))
  Downloading packaging-16.8-py2.py3-none-any.whl
Collecting parsedatetime==2.1 (from -r /tmp/tmp.JYJ3zJiaoE/letsencrypt-auto-requirements.txt (line 116))
  Downloading parsedatetime-2.1-py2-none-any.whl
Collecting pbr==1.8.1 (from -r /tmp/tmp.JYJ3zJiaoE/letsencrypt-auto-requirements.txt (line 119))
  Downloading pbr-1.8.1-py2.py3-none-any.whl (89kB)
Collecting pyOpenSSL==16.2.0 (from -r /tmp/tmp.JYJ3zJiaoE/letsencrypt-auto-requirements.txt (line 122))
  Downloading pyOpenSSL-16.2.0-py2.py3-none-any.whl (43kB)
Collecting pyparsing==2.1.8 (from -r /tmp/tmp.JYJ3zJiaoE/letsencrypt-auto-requirements.txt (line 125))
  Downloading pyparsing-2.1.8-py2.py3-none-any.whl (54kB)
Collecting pyRFC3339==1.0 (from -r /tmp/tmp.JYJ3zJiaoE/letsencrypt-auto-requirements.txt (line 134))
  Downloading pyRFC3339-1.0-py2.py3-none-any.whl
Collecting python-augeas==0.5.0 (from -r /tmp/tmp.JYJ3zJiaoE/letsencrypt-auto-requirements.txt (line 137))
  Downloading python-augeas-0.5.0.tar.gz (90kB)
Collecting pytz==2015.7 (from -r /tmp/tmp.JYJ3zJiaoE/letsencrypt-auto-requirements.txt (line 139))
  Downloading pytz-2015.7-py2.py3-none-any.whl (476kB)
Collecting requests==2.12.1 (from -r /tmp/tmp.JYJ3zJiaoE/letsencrypt-auto-requirements.txt (line 153))
  Downloading requests-2.12.1-py2.py3-none-any.whl (574kB)
Collecting six==1.10.0 (from -r /tmp/tmp.JYJ3zJiaoE/letsencrypt-auto-requirements.txt (line 156))
  Downloading six-1.10.0-py2.py3-none-any.whl
Collecting traceback2==1.4.0 (from -r /tmp/tmp.JYJ3zJiaoE/letsencrypt-auto-requirements.txt (line 159))
  Downloading traceback2-1.4.0-py2.py3-none-any.whl
Collecting unittest2==1.1.0 (from -r /tmp/tmp.JYJ3zJiaoE/letsencrypt-auto-requirements.txt (line 162))
  Downloading unittest2-1.1.0-py2.py3-none-any.whl (96kB)
Collecting zope.component==4.2.2 (from -r /tmp/tmp.JYJ3zJiaoE/letsencrypt-auto-requirements.txt (line 165))
  Downloading zope.component-4.2.2.tar.gz (546kB)
Collecting zope.event==4.1.0 (from -r /tmp/tmp.JYJ3zJiaoE/letsencrypt-auto-requirements.txt (line 167))
  Downloading zope.event-4.1.0.tar.gz (476kB)
Collecting zope.interface==4.1.3 (from -r /tmp/tmp.JYJ3zJiaoE/letsencrypt-auto-requirements.txt (line 169))
  Downloading zope.interface-4.1.3.tar.gz (141kB)
Collecting mock==2.0.0 (from -r /tmp/tmp.JYJ3zJiaoE/letsencrypt-auto-requirements.txt (line 187))
  Downloading mock-2.0.0-py2.py3-none-any.whl (56kB)
Collecting letsencrypt==0.7.0 (from -r /tmp/tmp.JYJ3zJiaoE/letsencrypt-auto-requirements.txt (line 198))
  Downloading letsencrypt-0.7.0-py2-none-any.whl
Collecting certbot==0.18.2 (from -r /tmp/tmp.JYJ3zJiaoE/letsencrypt-auto-requirements.txt (line 202))
  Downloading certbot-0.18.2-py2.py3-none-any.whl (270kB)
Collecting acme==0.18.2 (from -r /tmp/tmp.JYJ3zJiaoE/letsencrypt-auto-requirements.txt (line 205))
  Downloading acme-0.18.2-py2.py3-none-any.whl (99kB)
Collecting certbot-apache==0.18.2 (from -r /tmp/tmp.JYJ3zJiaoE/letsencrypt-auto-requirements.txt (line 208))
  Downloading certbot_apache-0.18.2-py2.py3-none-any.whl (135kB)
Collecting certbot-nginx==0.18.2 (from -r /tmp/tmp.JYJ3zJiaoE/letsencrypt-auto-requirements.txt (line 211))
  Downloading certbot_nginx-0.18.2-py2.py3-none-any.whl (65kB)
Requirement already satisfied: setuptools in /opt/eff.org/certbot/venv/lib/python2.6/site-packages (from zope.component==4.2.2->-r /tmp/tmp.JYJ3zJiaoE/letsencrypt-auto-requirements.txt (line 165))
Installing collected packages: pycparser, asn1crypto, cffi, ordereddict, ConfigArgParse, six, configobj, idna, ipaddress, enum34, cryptography, funcsigs, linecache2, pyparsing, packaging, parsedatetime, pbr, pyOpenSSL, pytz, pyRFC3339, python-augeas, requests, traceback2, unittest2, zope.interface, zope.event, zope.component, mock, acme, certbot, letsencrypt, certbot-apache, certbot-nginx
  Running setup.py install for pycparser: started
    Running setup.py install for pycparser: finished with status 'done'
  Running setup.py install for ordereddict: started
    Running setup.py install for ordereddict: finished with status 'done'
  Running setup.py install for ConfigArgParse: started
    Running setup.py install for ConfigArgParse: finished with status 'done'
  Running setup.py install for configobj: started
    Running setup.py install for configobj: finished with status 'done'
  Running setup.py install for ipaddress: started
    Running setup.py install for ipaddress: finished with status 'done'
  Running setup.py install for enum34: started
    Running setup.py install for enum34: finished with status 'done'
  Running setup.py install for python-augeas: started
    Running setup.py install for python-augeas: finished with status 'done'
  Running setup.py install for zope.interface: started
=====================================================

Certbot has problem setting up the virtual environment.

We were not be able to guess the right solution from your pip 
output.

Consult https://certbot.eff.org/docs/install.html#problems-with-python-virtual-environment
for possible solutions.
You may also find some support resources at https://certbot.eff.org/support/ .

#make the lighttpd pem file
cp /etc/letsencrypt/live/eastmanjian.cn/privkey.pem /etc/lighttpd/eastman_host.pem
+ cp /etc/letsencrypt/live/eastmanjian.cn/privkey.pem /etc/lighttpd/eastman_host.pem
cat /etc/letsencrypt/live/eastmanjian.cn/cert.pem >> /etc/lighttpd/eastman_host.pem
+ cat /etc/letsencrypt/live/eastmanjian.cn/cert.pem

#install the cert into glassfish server
cd /srv/glassfish4/glassfish/domains/domain1/config
+ cd /srv/glassfish4/glassfish/domains/domain1/config
keytool -delete -alias LetsEncrypt -keystore cacerts.jks -storepass $(echo "c2N1dHNjdXQK" | openssl base64 -d)
++ openssl base64 -d
++ echo c2N1dHNjdXQK
+ keytool -delete -alias LetsEncrypt -keystore cacerts.jks -storepass scutscut
keytool -delete -alias letsencryptim -keystore cacerts.jks -storepass $(echo "c2N1dHNjdXQK" | openssl base64 -d)
++ openssl base64 -d
++ echo c2N1dHNjdXQK
+ keytool -delete -alias letsencryptim -keystore cacerts.jks -storepass scutscut
keytool -delete -alias s1as -keystore keystore.jks -storepass $(echo "c2N1dHNjdXQK" | openssl base64 -d)
++ openssl base64 -d
++ echo c2N1dHNjdXQK
+ keytool -delete -alias s1as -keystore keystore.jks -storepass scutscut
keytool -import -v -trustcacerts -alias LetsEncrypt -file /etc/letsencrypt/live/eastmanjian.cn/fullchain.pem -keystore cacerts.jks -storepass $(echo "c2N1dHNjdXQK" | openssl base64 -d)
++ openssl base64 -d
++ echo c2N1dHNjdXQK
+ keytool -import -v -trustcacerts -alias LetsEncrypt -file /etc/letsencrypt/live/eastmanjian.cn/fullchain.pem -keystore cacerts.jks -storepass scutscut
Owner: CN=eastmanjian.cn
Issuer: CN=Let's Encrypt Authority X3, O=Let's Encrypt, C=US
Serial number: 4cf88e9b068010c52e2c69db00876b2df8b
Valid from: Thu Sep 14 21:20:00 EDT 2017 until: Wed Dec 13 20:20:00 EST 2017
Certificate fingerprints:
	 MD5:  50:0F:CD:E6:B2:E8:63:23:34:2C:08:83:8F:53:E8:80
	 SHA1: DD:47:FB:C5:00:36:6B:75:F1:54:38:54:83:FA:00:E6:20:79:98:92
	 SHA256: E6:52:04:DF:63:D6:D1:A1:2A:FD:55:D4:7C:FC:FA:AF:DB:63:B5:95:CC:8C:96:A9:5B:A4:71:4D:BC:34:6D:71
	 Signature algorithm name: SHA256withRSA
	 Version: 3

Extensions: 

#1: ObjectId: 1.3.6.1.5.5.7.1.1 Criticality=false
AuthorityInfoAccess [
  [
   accessMethod: ocsp
   accessLocation: URIName: http://ocsp.int-x3.letsencrypt.org
, 
   accessMethod: caIssuers
   accessLocation: URIName: http://cert.int-x3.letsencrypt.org/
]
]

#2: ObjectId: 2.5.29.35 Criticality=false
AuthorityKeyIdentifier [
KeyIdentifier [
0000: A8 4A 6A 63 04 7D DD BA   E6 D1 39 B7 A6 45 65 EF  .Jjc......9..Ee.
0010: F3 A8 EC A1                                        ....
]
]

#3: ObjectId: 2.5.29.19 Criticality=true
BasicConstraints:[
  CA:false
  PathLen: undefined
]

#4: ObjectId: 2.5.29.32 Criticality=false
CertificatePolicies [
  [CertificatePolicyId: [2.23.140.1.2.1]
[]  ]
  [CertificatePolicyId: [1.3.6.1.4.1.44947.1.1.1]
[PolicyQualifierInfo: [
  qualifierID: 1.3.6.1.5.5.7.2.1
  qualifier: 0000: 16 1A 68 74 74 70 3A 2F   2F 63 70 73 2E 6C 65 74  ..http://cps.let
0010: 73 65 6E 63 72 79 70 74   2E 6F 72 67              sencrypt.org

], PolicyQualifierInfo: [
  qualifierID: 1.3.6.1.5.5.7.2.2
  qualifier: 0000: 30 81 9E 0C 81 9B 54 68   69 73 20 43 65 72 74 69  0.....This Certi
0010: 66 69 63 61 74 65 20 6D   61 79 20 6F 6E 6C 79 20  ficate may only 
0020: 62 65 20 72 65 6C 69 65   64 20 75 70 6F 6E 20 62  be relied upon b
0030: 79 20 52 65 6C 79 69 6E   67 20 50 61 72 74 69 65  y Relying Partie
0040: 73 20 61 6E 64 20 6F 6E   6C 79 20 69 6E 20 61 63  s and only in ac
0050: 63 6F 72 64 61 6E 63 65   20 77 69 74 68 20 74 68  cordance with th
0060: 65 20 43 65 72 74 69 66   69 63 61 74 65 20 50 6F  e Certificate Po
0070: 6C 69 63 79 20 66 6F 75   6E 64 20 61 74 20 68 74  licy found at ht
0080: 74 70 73 3A 2F 2F 6C 65   74 73 65 6E 63 72 79 70  tps://letsencryp
0090: 74 2E 6F 72 67 2F 72 65   70 6F 73 69 74 6F 72 79  t.org/repository
00A0: 2F                                                 /

]]  ]
]

#5: ObjectId: 2.5.29.37 Criticality=false
ExtendedKeyUsages [
  serverAuth
  clientAuth
]

#6: ObjectId: 2.5.29.15 Criticality=true
KeyUsage [
  DigitalSignature
  Key_Encipherment
]

#7: ObjectId: 2.5.29.17 Criticality=false
SubjectAlternativeName [
  DNSName: eastmanjian.cn
]

#8: ObjectId: 2.5.29.14 Criticality=false
SubjectKeyIdentifier [
KeyIdentifier [
0000: 47 5C 8D 4F D2 41 20 3A   5D 51 D0 E1 A8 6B 26 8A  G\.O.A :]Q...k&.
0010: 9C F9 76 4E                                        ..vN
]
]

Trust this certificate? [no]:  keytool error: java.lang.NullPointerException
java.lang.NullPointerException
	at java.text.RuleBasedCollator.compare(RuleBasedCollator.java:357)
	at sun.security.tools.keytool.Main.getYesNoReply(Main.java:3474)
	at sun.security.tools.keytool.Main.addTrustedCert(Main.java:2719)
	at sun.security.tools.keytool.Main.doCommands(Main.java:1009)
	at sun.security.tools.keytool.Main.run(Main.java:343)
	at sun.security.tools.keytool.Main.main(Main.java:336)
keytool -import -v -trustcacerts -alias letsencryptim -file /etc/letsencrypt/live/eastmanjian.cn/chain.pem -keystore cacerts.jks -storepass $(echo "c2N1dHNjdXQK" | openssl base64 -d)
++ openssl base64 -d
++ echo c2N1dHNjdXQK
+ keytool -import -v -trustcacerts -alias letsencryptim -file /etc/letsencrypt/live/eastmanjian.cn/chain.pem -keystore cacerts.jks -storepass scutscut
Certificate was added to keystore
[Storing cacerts.jks]
openssl pkcs12 -export -inkey /etc/letsencrypt/live/eastmanjian.cn/privkey.pem -in /etc/letsencrypt/live/eastmanjian.cn/fullchain.pem -name s1as -out test.p12 -passout pass:$(echo "c2N1dHNjdXQK" | openssl base64 -d)
++ openssl base64 -d
++ echo c2N1dHNjdXQK
+ openssl pkcs12 -export -inkey /etc/letsencrypt/live/eastmanjian.cn/privkey.pem -in /etc/letsencrypt/live/eastmanjian.cn/fullchain.pem -name s1as -out test.p12 -passout pass:scutscut
keytool -importkeystore -srckeystore test.p12 -srcstoretype pkcs12 -destkeystore keystore.jks -destkeypass $(echo "c2N1dHNjdXQK" | openssl base64 -d) -srckeypass $(echo "c2N1dHNjdXQK" | openssl base64 -d)
++ openssl base64 -d
++ echo c2N1dHNjdXQK
++ openssl base64 -d
++ echo c2N1dHNjdXQK
+ keytool -importkeystore -srckeystore test.p12 -srcstoretype pkcs12 -destkeystore keystore.jks -destkeypass scutscut -srckeypass scutscut
Enter destination keystore password:  Keystore password is too short - must be at least 6 characters
Enter destination keystore password:  Keystore password is too short - must be at least 6 characters
Enter destination keystore password:  Keystore password is too short - must be at least 6 characters
Too many failures - try later

